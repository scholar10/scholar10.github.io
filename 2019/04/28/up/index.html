<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Upload-Labs wp | Sch0lar's Blog</title><meta name="description" content="Upload-Labs wp"><meta name="keywords" content="upload"><meta name="author" content="Sch0lar"><meta name="copyright" content="Sch0lar"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Upload-Labs wp"><meta name="twitter:description" content="Upload-Labs wp"><meta name="twitter:image" content="https://i.loli.net/2019/11/06/gaQDzWELk5iJnrP.png"><meta property="og:type" content="article"><meta property="og:title" content="Upload-Labs wp"><meta property="og:url" content="http://yoursite.com/2019/04/28/up/"><meta property="og:site_name" content="Sch0lar's Blog"><meta property="og:description" content="Upload-Labs wp"><meta property="og:image" content="https://i.loli.net/2019/11/06/gaQDzWELk5iJnrP.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://yoursite.com/2019/04/28/up/"><link rel="prev" title="Python正则表达式" href="http://yoursite.com/2019/05/04/Python正则表达式/"><link rel="next" title="西湖论剑web 3题 解析" href="http://yoursite.com/2019/04/11/西湖论剑web-3题-解析/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"cookieDomain":"https://poc10.cn/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'false',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  copyright: undefined,
  copy_copyright_js: false,
  ClickShowText: undefined,
  medium_zoom: 'false',
  Snackbar: undefined
  
}</script></head><body><div id="header"> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Sch0lar's Blog</a></span><i class="fa fa-bars fa-fw toggle-menu pull_right close" aria-hidden="true"></i><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></span><span class="pull_right" id="search_button"></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lazyload avatar_img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">24</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">20</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">7</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">Catalog</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Pass-01"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">Pass-01</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Pass-02"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">Pass-02</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Pass-03"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">Pass-03</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Pass-04"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">Pass-04</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Pass-05"><span class="toc_mobile_items-number">5.</span> <span class="toc_mobile_items-text">Pass-05</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Pass-06"><span class="toc_mobile_items-number">6.</span> <span class="toc_mobile_items-text">Pass-06</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Pass-07"><span class="toc_mobile_items-number">7.</span> <span class="toc_mobile_items-text">Pass-07</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Pass-08"><span class="toc_mobile_items-number">8.</span> <span class="toc_mobile_items-text">Pass-08</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Pass-09"><span class="toc_mobile_items-number">9.</span> <span class="toc_mobile_items-text">Pass-09</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Pass-10"><span class="toc_mobile_items-number">10.</span> <span class="toc_mobile_items-text">Pass-10</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Pass-11"><span class="toc_mobile_items-number">11.</span> <span class="toc_mobile_items-text">Pass-11</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Pass-12"><span class="toc_mobile_items-number">12.</span> <span class="toc_mobile_items-text">Pass-12</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Pass-13"><span class="toc_mobile_items-number">13.</span> <span class="toc_mobile_items-text">Pass-13</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Pass-14"><span class="toc_mobile_items-number">14.</span> <span class="toc_mobile_items-text">Pass-14</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Pass-15"><span class="toc_mobile_items-number">15.</span> <span class="toc_mobile_items-text">Pass-15</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Pass-16"><span class="toc_mobile_items-number">16.</span> <span class="toc_mobile_items-text">Pass-16</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Pass-17"><span class="toc_mobile_items-number">17.</span> <span class="toc_mobile_items-text">Pass-17</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Pass-18"><span class="toc_mobile_items-number">18.</span> <span class="toc_mobile_items-text">Pass-18</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Pass-19"><span class="toc_mobile_items-number">19.</span> <span class="toc_mobile_items-text">Pass-19</span></a></li></ol></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-01"><span class="toc-number">1.</span> <span class="toc-text">Pass-01</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-02"><span class="toc-number">2.</span> <span class="toc-text">Pass-02</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-03"><span class="toc-number">3.</span> <span class="toc-text">Pass-03</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-04"><span class="toc-number">4.</span> <span class="toc-text">Pass-04</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-05"><span class="toc-number">5.</span> <span class="toc-text">Pass-05</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-06"><span class="toc-number">6.</span> <span class="toc-text">Pass-06</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-07"><span class="toc-number">7.</span> <span class="toc-text">Pass-07</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-08"><span class="toc-number">8.</span> <span class="toc-text">Pass-08</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-09"><span class="toc-number">9.</span> <span class="toc-text">Pass-09</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-10"><span class="toc-number">10.</span> <span class="toc-text">Pass-10</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-11"><span class="toc-number">11.</span> <span class="toc-text">Pass-11</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-12"><span class="toc-number">12.</span> <span class="toc-text">Pass-12</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-13"><span class="toc-number">13.</span> <span class="toc-text">Pass-13</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-14"><span class="toc-number">14.</span> <span class="toc-text">Pass-14</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-15"><span class="toc-number">15.</span> <span class="toc-text">Pass-15</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-16"><span class="toc-number">16.</span> <span class="toc-text">Pass-16</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-17"><span class="toc-number">17.</span> <span class="toc-text">Pass-17</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-18"><span class="toc-number">18.</span> <span class="toc-text">Pass-18</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-19"><span class="toc-number">19.</span> <span class="toc-text">Pass-19</span></a></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://i.loli.net/2019/11/06/gaQDzWELk5iJnrP.png)"><div id="post-info"><div id="post-title"><div class="posttitle">Upload-Labs wp</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> Created 2019-04-28<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> Updated 2019-04-28</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/web安全/">web安全</a></span><div class="post-meta-wordcount"><i class="fa fa-eye post-meta__icon" aria-hidden="true">       </i><span>Post View: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><p><img alt="mind-map.png" data-src="https://i.loli.net/2019/04/24/5cbfe060c7285.png" class="lazyload"></p>
<p>一个上传漏洞总结的很全的靶场</p>
<a id="more"></a>
<p>因为最近效率比较低(难听点就是懒) 所以国光哥说</p>
<p>可以一天搞完这些东西然后写篇博客 逼自己一下</p>
<p>本来是应该一天搞完的结果学校停电了没网</p>
<p><img alt="QQ图片20190426163558.jpg" data-src="https://i.loli.net/2019/04/26/5cc2c2fe0869d.jpg" class="lazyload"></p>
<p>真的不是在找借口哈</p>
<p>不过也真的学到了很多新姿势呀。</p>
<h2 id="Pass-01"><a href="#Pass-01" class="headerlink" title="Pass-01"></a>Pass-01</h2><p>猜测第一关应该比较简单前端验证</p>
<p>创建后缀为jpg的文件</p>
<p><img alt="Xnip2019-04-24_11-53-42.jpg" data-src="https://i.loli.net/2019/04/24/5cbfdddbafa91.jpg" class="lazyload"></p>
<p>上传 抓包改后缀即可绕过</p>
<p><img alt="Xnip2019-04-24_11-56-29.jpg" data-src="https://i.loli.net/2019/04/24/5cbfde79e959d.jpg" class="lazyload"></p>
<h2 id="Pass-02"><a href="#Pass-02" class="headerlink" title="Pass-02"></a>Pass-02</h2><p>第二题 也是比较常见的</p>
<p>猜测是验证content-type</p>
<p>于是修改content-type为jpg的类型 即可绕过。</p>
<p><img alt="Xnip2019-04-24_11-59-28.jpg" data-src="https://i.loli.net/2019/04/24/5cbfdf34610f6.jpg" class="lazyload"></p>
<h2 id="Pass-03"><a href="#Pass-03" class="headerlink" title="Pass-03"></a>Pass-03</h2><p><img alt="QQ截图20190426114844.png" data-src="https://i.loli.net/2019/04/26/5cc27fa4c9363.png" class="lazyload"></p>
<p>上传一个php文件发现 黑名单上传 立即想到的就是大小写混合绕过</p>
<p>试了一下不可以 查看源码发现都被转换成了小写GG了</p>
<p>把后缀改为php3上传成功解析</p>
<p><img alt="QQ截图20190426120230.png" data-src="https://i.loli.net/2019/04/26/5cc282e0cb7c8.png" class="lazyload"></p>
<p>貌似是apache里面的设置 会把php3当作php去解析</p>
<p>第一次在mac下搭建环境却一直不能成功 </p>
<p>还有另一种姿势 上传<code>.htaccess</code>。</p>
<h2 id="Pass-04"><a href="#Pass-04" class="headerlink" title="Pass-04"></a>Pass-04</h2><p>这就用到了前面说的.htaccess了</p>
<p>因为还是黑名单验证 我们可以上传一个<code>.htaccess</code>上去</p>
<p>内容为</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;FilesMatch ".jpg"&gt;</span></span><br><span class="line"><span class="attribute"><span class="nomarkup">SetHandler</span></span> application/x-httpd-php</span><br><span class="line"><span class="section">&lt;/FilesMatch&gt;</span></span><br></pre></td></tr></table></figure>
<p>把.jpg的文件当作php去解析</p>
<p><img alt="QQ截图20190426120144.png" data-src="https://i.loli.net/2019/04/26/5cc282bb2022e.png" class="lazyload"></p>
<h2 id="Pass-05"><a href="#Pass-05" class="headerlink" title="Pass-05"></a>Pass-05</h2><p>还是黑名单验证 不过呢这里也过滤<code>.htaccess</code>了</p>
<p>但是反过来观察一下 这里却没有进行大小写的转换 PhP直接上传</p>
<p>美滋滋</p>
<p><img alt="QQ截图20190426121657.png" data-src="https://i.loli.net/2019/04/26/5cc2864239c6e.png" class="lazyload"></p>
<h2 id="Pass-06"><a href="#Pass-06" class="headerlink" title="Pass-06"></a>Pass-06</h2><p>还是黑名单验证</p>
<p>回头看看思维导图</p>
<p>黑名单验证里的空格绕过 这时候源码里并没有过滤空格  所以在.php后添加空格即可绕过</p>
<h2 id="Pass-07"><a href="#Pass-07" class="headerlink" title="Pass-07"></a>Pass-07</h2><p>黑名单验证</p>
<p>这题最开始有点蒙 看了源码也没想到。。太菜了</p>
<p>偷偷看了网上的wp</p>
<p>忽略了本题没有对后缀进行去.的处理</p>
<p>利用windows的特性会自动去掉后面的.</p>
<p>上传<code>07.php.</code>即可绕过</p>
<p><img alt="QQ截图20190426124530.png" data-src="https://i.loli.net/2019/04/26/5cc28d48461a9.png" class="lazyload"></p>
<h2 id="Pass-08"><a href="#Pass-08" class="headerlink" title="Pass-08"></a>Pass-08</h2><p>黑名单验证</p>
<p>这次发现了重点 没有去除字符串<code>::$DATA</code></p>
<p>这种方法实战没用到过 ctf也没用到过 </p>
<p>仔细查了一下涨姿势了</p>
<p>必须是windows, 必须是php<br>php在window的时候如果文件名+”::$DATA”会把::$DATA之后的数据当成文件流处理,不会检测后缀名.且保持”::$DATA”之前的文件名<br>他的目的就是不检查后缀名….</p>
<p>上传xx.php::$DATA发现无法找到此文件</p>
<p>windows会去掉::$DATA 直接访问xx.php即可</p>
<p><img alt="QQ截图20190426125751.png" data-src="https://i.loli.net/2019/04/26/5cc2901e8fb0f.png" class="lazyload"></p>
<h2 id="Pass-09"><a href="#Pass-09" class="headerlink" title="Pass-09"></a>Pass-09</h2><p>到这里又没了思路。。</p>
<p>思维导图是个好东西。</p>
<p>最常用的陌生后缀解析漏洞都给忘了</p>
<p>我上传一个09.php.xxx</p>
<p>apache的特性从右往左依次解析 不认识的后缀会一直往左解析 </p>
<p>无法解析xxx就解析成了php。上传成功</p>
<p><img alt="QQ截图20190426130942.png" data-src="https://i.loli.net/2019/04/26/5cc292da2a70a.png" class="lazyload"></p>
<h2 id="Pass-10"><a href="#Pass-10" class="headerlink" title="Pass-10"></a>Pass-10</h2><p>到了10题以后源码上就没了注释了</p>
<p>这里我自己写一下注释也为了巩固一下php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$is_upload = <span class="keyword">false</span>;</span><br><span class="line">$msg = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        $deny_ext = <span class="keyword">array</span>(<span class="string">"php"</span>,<span class="string">"php5"</span>,<span class="string">"php4"</span>,<span class="string">"php3"</span>,<span class="string">"php2"</span>,<span class="string">"html"</span>,<span class="string">"htm"</span>,<span class="string">"phtml"</span>,<span class="string">"pht"</span>,<span class="string">"jsp"</span>,<span class="string">"jspa"</span>,<span class="string">"jspx"</span>,<span class="string">"jsw"</span>,<span class="string">"jsv"</span>,<span class="string">"jspf"</span>,<span class="string">"jtml"</span>,<span class="string">"asp"</span>,<span class="string">"aspx"</span>,<span class="string">"asa"</span>,<span class="string">"asax"</span>,<span class="string">"ascx"</span>,<span class="string">"ashx"</span>,<span class="string">"asmx"</span>,<span class="string">"cer"</span>,<span class="string">"swf"</span>,<span class="string">"htaccess"</span>);<span class="comment">//黑名单</span></span><br><span class="line"></span><br><span class="line">        $file_name = trim($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]);</span><br><span class="line">        <span class="comment">//移除字符串两侧的空白字符。也就是这里为什么不能空格绕黑名单的原因喽</span></span><br><span class="line">        $file_name = str_ireplace($deny_ext,<span class="string">""</span>, $file_name);<span class="comment">//将问题后缀名替换为空</span></span><br><span class="line">        $temp_file = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">        $img_path = UPLOAD_PATH.<span class="string">'/'</span>.$file_name;        </span><br><span class="line">        <span class="keyword">if</span> (move_uploaded_file($temp_file, $img_path)) &#123;</span><br><span class="line">            $is_upload = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $msg = <span class="string">'上传出错！'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = UPLOAD_PATH . <span class="string">'文件夹不存在,请手工创建！'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>读懂了源码</p>
<p>发现这才是重点</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_name</span> = str_ireplace(<span class="variable">$deny_ext</span>,<span class="string">""</span>, <span class="variable">$file_name</span>);<span class="regexp">//</span>将问题后缀名替换为空</span><br></pre></td></tr></table></figure>
<p>替换为空所以我们双写绕过</p>
<p><img alt="QQ截图20190426140902.png" data-src="https://i.loli.net/2019/04/26/5cc2a0e99cf21.png" class="lazyload"></p>
<p><img alt="QQ截图20190426140955.png" data-src="https://i.loli.net/2019/04/26/5cc2a0f1303c0.png" class="lazyload"></p>
<h2 id="Pass-11"><a href="#Pass-11" class="headerlink" title="Pass-11"></a>Pass-11</h2><p>白名单验证</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$file<span class="emphasis">_ext = substr($_</span>FILES[<span class="string">'upload_file'</span>][<span class="symbol">'name'</span>],strrpos($<span class="emphasis">_FILES['upload_</span>file'</span><br><span class="line">['name'],".")+1);</span><br></pre></td></tr></table></figure>
<p>先介绍一下函数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">substr(string,<span class="keyword">start</span>,<span class="keyword">length</span>)//返回<span class="keyword">string</span>从<span class="keyword">start</span>开始的<span class="keyword">length</span>长度</span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">strrpos</span><span class="params">($_FILES[<span class="string">'upload_file'</span>[<span class="string">'name'</span>],<span class="string">"."</span>)</span></span><span class="comment">//查找.在文件里最后一次出现的位置</span></span><br></pre></td></tr></table></figure>
<p>回过头来看题 查找文件名中最后一个点后面的后缀 也就是说这行代码就防止了我们 <strong>双后缀名绕过</strong></p>
<p>那么该怎么做呢</p>
<p>博客前面写过类似的方法</p>
<p>在路径上11.php后面进行截断后端则会认为11.php 是文件名 真实文件名被截断了所以改成11.jpg进行绕过即可</p>
<p>get会对%00进行自解码所以不用解码</p>
<p><img alt="QQ截图20190426144229.png" data-src="https://i.loli.net/2019/04/26/5cc2a8826d6ed.png" class="lazyload"></p>
<p><strong>截断条件：</strong><br><strong>php版本小于5.3.4 详情关注CVE-2006-7243</strong><br><strong>php的magic_quotes_gpc为OFF状态</strong></p>
<h2 id="Pass-12"><a href="#Pass-12" class="headerlink" title="Pass-12"></a>Pass-12</h2><p>与上面题目类似</p>
<p>只不过这题save_path是通过post传输的</p>
<p><img alt="QQ截图20190426154635.png" data-src="https://i.loli.net/2019/04/26/5cc2b7660bfaa.png" class="lazyload"></p>
<p>post不会像get对%00进行自动解码 所以%00解码</p>
<h2 id="Pass-13"><a href="#Pass-13" class="headerlink" title="Pass-13"></a>Pass-13</h2><p><img alt="QQ截图20190426154813.png" data-src="https://i.loli.net/2019/04/26/5cc2b7c843013.png" class="lazyload"></p>
<p>13题与前面都不同 上传图片马 然后利用文件包含漏洞 包含phpinfo</p>
<p>dos下命令制作图片马</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">copy <span class="number">1.</span>jpg /b + <span class="number">1.</span>php /a <span class="number">13.</span>jpg</span><br><span class="line">参数/b指定以二进制格式复制、合并文件; 用于图像类/声音类文件</span><br><span class="line">参数/a指定以ASCII格式复制、合并文件。用于txt等文档类文件</span><br><span class="line">copy <span class="number">1.</span>jpg /b + <span class="number">1.</span>php /a <span class="number">13.</span>jpg </span><br><span class="line"><span class="comment">//意思是将1.jpg以二进制与1.php合并成13.jpg</span></span><br><span class="line">那么<span class="number">2.</span>jpg就是图片木马了。</span><br></pre></td></tr></table></figure>
<p><img alt="QQ截图20190426155736.png" data-src="https://i.loli.net/2019/04/26/5cc2baf061944.png" class="lazyload"></p>
<p>生成出来这时候利用文件包含漏洞 包含该文件即可</p>
<p><img alt="QQ截图20190426160102.png" data-src="https://i.loli.net/2019/04/26/5cc2bad3e2be3.png" class="lazyload"></p>
<p>jpg gif是一个道理的。</p>
<h2 id="Pass-14"><a href="#Pass-14" class="headerlink" title="Pass-14"></a>Pass-14</h2><p>与<code>Pass-13</code>是一样的突破方法</p>
<p>唯一不同的是getimagesize获取文件类型</p>
<p>我们直接上传的本来就是图片类型。所以姿势是一样的。</p>
<h2 id="Pass-15"><a href="#Pass-15" class="headerlink" title="Pass-15"></a>Pass-15</h2><p>多了个php_exif模块来判断文件类型</p>
<p>突破方法与<code>Pass-13</code>一致</p>
<h2 id="Pass-16"><a href="#Pass-16" class="headerlink" title="Pass-16"></a>Pass-16</h2><p><del>突破方法与<code>Pass-13</code>一致</del></p>
<p><img alt="QQ图片20190426163558.jpg" data-src="https://i.loli.net/2019/04/26/5cc2c2fe0869d.jpg" class="lazyload"></p>
<p>本来以为还是和前面方法一致但是文件包含的时候却不行</p>
<p>查看源代码发现考察的是二次渲染 姿势盲区了 故查了下资料(百度太垃圾什么也没有用google哦)</p>
<p>普通的图片马上传以后</p>
<p>经过<code>imagecreatefromjpeg</code></p>
<p>函数二次渲染，图片尾部的php一句话被删除</p>
<p>看了一篇类似的文章 可以通过对比上传前后的图片内容</p>
<p>找到上传前没有改变的部分将一句话写道没有改变的这部分尝试一下</p>
<p>由于我这里没有16进制编辑器 就不尝试了 不过应该没有问题。。</p>
<p>google看到的copy过来 对渲染了解的少 需要多了解了解。</p>
<p><strong>将一个正常显示的图片，上传到服务器。寻找图片被渲染后与原始图片部分对比仍然相同的数据块部分，将Webshell代码插在该部分，然后上传。具体实现需要自己编写Python程序，人工尝试基本是不可能构造出能绕过渲染函数的图片webshell的。</strong></p>
<h2 id="Pass-17"><a href="#Pass-17" class="headerlink" title="Pass-17"></a>Pass-17</h2><p>考察条件竞争</p>
<p>如果你要问条件竞争是什么，可以看一下这篇文章</p>
<p><a href="https://shuaizhupeiqi.github.io/2018/11/15/%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">CTF中的条件竞争漏洞</a></p>
<p>关于条件竞争不怎么明白 Google了半天发现无法突破本关 </p>
<p>于是厚着脸皮让国光哥来远程。。。涨姿势了</p>
<p>总结出来一句话利用burp批量发包 让程序措手不及</p>
<p>上传1.php抓包</p>
<p><img alt="1556373645543.png" data-src="https://i.loli.net/2019/04/27/5cc47b784a603.png" class="lazyload"><br><img alt="1556373629324.png" data-src="https://i.loli.net/2019/04/27/5cc47b78637ed.png" class="lazyload"><br><img alt="1556373601185.png" data-src="https://i.loli.net/2019/04/27/5cc47b7a6d648.png" class="lazyload"></p>
<p>线程设置高一点 开始不断发包 在我和国光哥的10分钟不断刷新下果然成功了。。。</p>
<p>产生原因将文件上传，然后判断后缀是否是图片，如果不是图片文件则将其删除。</p>
<h2 id="Pass-18"><a href="#Pass-18" class="headerlink" title="Pass-18"></a>Pass-18</h2><p>条件竞争</p>
<p>利用<code>Pass-17</code>方法一样可以利用</p>
<p>但是我这边一直没有成功呢。。。姿势问题</p>
<h2 id="Pass-19"><a href="#Pass-19" class="headerlink" title="Pass-19"></a>Pass-19</h2><p>到了这里发现越来越简单</p>
<p>move_uploaded_file()函数中的img_path是由post参数save_name控制的，因此可以在save_name利用00截断绕过</p>
<p><img alt="1.png" data-src="https://i.loli.net/2019/04/27/5cc47b1371aa0.png" class="lazyload"></p>
<p>感觉这题和12题有点类似</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Sch0lar</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2019/04/28/up/">http://yoursite.com/2019/04/28/up/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/upload/">upload    </a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2019/11/06/gaQDzWELk5iJnrP.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button"><i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/05/04/Python正则表达式/"><img class="prev_cover lazyload" data-src="https://i.loli.net/2019/11/06/gaQDzWELk5iJnrP.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Previous Post</div><div class="prev_info"><span>Python正则表达式</span></div></a></div><div class="next-post pull_right"><a href="/2019/04/11/西湖论剑web-3题-解析/"><img class="next_cover lazyload" data-src="https://i.loli.net/2019/11/06/gaQDzWELk5iJnrP.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Next Post</div><div class="next_info"><span>西湖论剑web 3题 解析</span></div></a></div></nav></div></div><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2019 By Sch0lar</div><div class="framework-info"><span>Driven </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">简</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>